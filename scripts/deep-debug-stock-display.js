const { sequelize } = require('../src/config/database');
const { 
  Company, Bar, Product, Format, Stock, Reserve, ReserveStock, 
  User, StockHistory, ReserveTransfer 
} = require('../src/models');

async function deepDebugStockDisplay() {
  try {
    console.log('üîç DIAGNOSTIC APPROFONDI - Probl√®me affichage stocks\n');
    console.log('=' .repeat(70));
    
    // 1. Lister TOUS les bars disponibles
    console.log('üìã √âTAPE 1: Tous les bars dans la base');
    const allBars = await Bar.findAll({
      include: [Company],
      order: [['id', 'ASC']]
    });
    
    console.log(`   Total bars: ${allBars.length}`);
    allBars.forEach(bar => {
      console.log(`   - ID: ${bar.id}, Nom: "${bar.name}", Entreprise: ${bar.Company ? bar.Company.name : 'N/A'}`);
    });
    
    // 2. V√©rifier les stocks pour CHAQUE bar
    console.log('\nüìä √âTAPE 2: Stocks par bar');
    
    for (const bar of allBars) {
      console.log(`\n   üç∫ ${bar.name} (ID: ${bar.id}):`);
      
      const stockCount = await Stock.count({ where: { barId: bar.id } });
      console.log(`      Nombre de stocks: ${stockCount}`);
      
      if (stockCount > 0) {
        // Test API direct pour ce bar
        console.log(`      üåê Test API GET /stocks?barId=${bar.id}:`);
        
        try {
          const stockController = require('../src/controllers/stockController');
          
          const mockReq = {
            query: { barId: bar.id.toString() }
          };
          
          const mockRes = {
            statusCode: null,
            jsonData: null,
            status: function(code) {
              this.statusCode = code;
              return this;
            },
            json: function(data) {
              this.jsonData = data;
              return this;
            }
          };
          
          await stockController.getAllStocks(mockReq, mockRes);
          
          console.log(`         Status: ${mockRes.statusCode}`);
          console.log(`         Success: ${mockRes.jsonData?.success}`);
          console.log(`         Count: ${mockRes.jsonData?.count || 0}`);
          
          if (mockRes.jsonData?.data && mockRes.jsonData.data.length > 0) {
            // Analyser la structure du premier stock
            const firstStock = mockRes.jsonData.data[0];
            console.log(`         Premier stock:`, {
              id: firstStock.id,
              barId: firstStock.barId,
              currentQuantity: firstStock.currentQuantity,
              minThreshold: firstStock.minThreshold,
              maxThreshold: firstStock.maxThreshold,
              hasBar: !!firstStock.Bar,
              barName: firstStock.Bar?.name,
              hasProduct: !!firstStock.Product,
              productName: firstStock.Product?.name,
              hasFormat: !!firstStock.Format,
              formatSize: firstStock.Format?.size,
              // V√©rifier si les anciennes colonnes existent encore
              hasOldMinQuantity: firstStock.minQuantity !== undefined,
              hasOldIdealQuantity: firstStock.idealQuantity !== undefined
            });
            
            // V√©rifier si toutes les relations sont charg√©es
            const missingRelations = [];
            if (!firstStock.Bar) missingRelations.push('Bar');
            if (!firstStock.Product) missingRelations.push('Product');  
            if (!firstStock.Format) missingRelations.push('Format');
            
            if (missingRelations.length > 0) {
              console.log(`         ‚ö†Ô∏è  Relations manquantes: ${missingRelations.join(', ')}`);
            } else {
              console.log(`         ‚úÖ Toutes les relations charg√©es`);
            }
            
          } else {
            console.log(`         ‚ùå Aucune donn√©e retourn√©e`);
          }
          
        } catch (apiError) {
          console.log(`         ‚ùå Erreur API: ${apiError.message}`);
        }
        
      } else {
        console.log(`      ‚ùå Aucun stock pour ce bar`);
      }
    }
    
    // 3. V√©rifier les relations dans la base de donn√©es
    console.log('\nüîó √âTAPE 3: V√©rification des relations');
    
    const stocksWithRelations = await Stock.findAll({
      include: [
        { model: Bar, required: false },
        { model: Product, required: false },
        { model: Format, required: false }
      ],
      limit: 5
    });
    
    console.log(`   Stocks avec relations test√©s: ${stocksWithRelations.length}`);
    
    stocksWithRelations.forEach((stock, index) => {
      console.log(`   Stock ${index + 1}:`, {
        id: stock.id,
        barId: stock.barId,
        productId: stock.productId,
        formatId: stock.formatId,
        barLoaded: !!stock.Bar,
        productLoaded: !!stock.Product,
        formatLoaded: !!stock.Format
      });
    });
    
    // 4. V√©rifier sp√©cifiquement le contr√¥leur Stock
    console.log('\nüéØ √âTAPE 4: Test du contr√¥leur Stock avec relations');
    
    try {
      const stocksFromController = await Stock.findAll({
        include: [
          {
            model: Format,
            include: [Product]
          },
          Bar
        ],
        limit: 3
      });
      
      console.log(`   Stocks du contr√¥leur: ${stocksFromController.length}`);
      
      stocksFromController.forEach((stock, index) => {
        console.log(`   Stock ${index + 1} d√©taill√©:`);
        console.log(`     - ID: ${stock.id}`);
        console.log(`     - Bar: ${stock.Bar ? stock.Bar.name : 'MANQUANT'}`);
        console.log(`     - Format: ${stock.Format ? stock.Format.size : 'MANQUANT'}`);
        console.log(`     - Produit: ${stock.Format?.Product ? stock.Format.Product.name : 'MANQUANT'}`);
        console.log(`     - Quantit√©s: ${stock.currentQuantity}/${stock.minThreshold}/${stock.maxThreshold}`);
      });
      
    } catch (controllerError) {
      console.log(`   ‚ùå Erreur contr√¥leur: ${controllerError.message}`);
    }
    
    // 5. Tester diff√©rents appels API
    console.log('\nüåê √âTAPE 5: Tests APIs multiples');
    
    const testCases = [
      { description: 'Tous les stocks', url: '/stocks' },
      { description: 'Stocks Bar ID 1', url: '/stocks?barId=1' },
      { description: 'Stocks Bar ID 2', url: '/stocks?barId=2' },
      { description: 'Produits √† recharger Bar 1', url: '/stocks/restock/1' },
      { description: 'Produits √† recharger Bar 2', url: '/stocks/restock/2' }
    ];
    
    for (const testCase of testCases) {
      console.log(`\n   üß™ Test: ${testCase.description}`);
      
      try {
        const stockController = require('../src/controllers/stockController');
        
        let mockReq, handler;
        
        if (testCase.url.includes('/restock/')) {
          const barId = testCase.url.split('/').pop();
          mockReq = { params: { barId } };
          handler = stockController.getStocksToRestock;
        } else {
          const queryParams = {};
          if (testCase.url.includes('barId=')) {
            queryParams.barId = testCase.url.split('barId=')[1];
          }
          mockReq = { query: queryParams };
          handler = stockController.getAllStocks;
        }
        
        const mockRes = {
          statusCode: null,
          jsonData: null,
          status: function(code) {
            this.statusCode = code;
            return this;
          },
          json: function(data) {
            this.jsonData = data;
            return this;
          }
        };
        
        await handler(mockReq, mockRes);
        
        console.log(`      Status: ${mockRes.statusCode}`);
        console.log(`      Success: ${mockRes.jsonData?.success}`);
        console.log(`      Count: ${mockRes.jsonData?.count || 0}`);
        
        if (mockRes.jsonData?.error) {
          console.log(`      ‚ùå Erreur: ${mockRes.jsonData.error}`);
        }
        
      } catch (testError) {
        console.log(`      ‚ùå Erreur test: ${testError.message}`);
      }
    }
    
    // 6. Recommandations
    console.log('\nüõ†Ô∏è  √âTAPE 6: Recommandations de correction');
    
    const totalStocks = await Stock.count();
    const totalBars = await Bar.count();
    
    if (totalStocks === 0) {
      console.log('‚ùå PROBL√àME: Aucun stock dans la base de donn√©es');
      console.log('   ‚Üí Ex√©cutez: node scripts/populate-full-database.js');
    } else if (totalBars === 0) {
      console.log('‚ùå PROBL√àME: Aucun bar dans la base de donn√©es');
      console.log('   ‚Üí Ex√©cutez: node scripts/populate-full-database.js');
    } else {
      console.log('‚úÖ Donn√©es pr√©sentes dans la base');
      console.log(`   ‚Üí ${totalStocks} stocks, ${totalBars} bars`);
      
      // V√©rifier les relations
      const stocksWithoutBar = await Stock.count({ where: { barId: null } });
      const stocksWithoutFormat = await Stock.count({ where: { formatId: null } });
      const stocksWithoutProduct = await Stock.count({ where: { productId: null } });
      
      if (stocksWithoutBar > 0) console.log(`   ‚ö†Ô∏è  ${stocksWithoutBar} stocks sans bar`);
      if (stocksWithoutFormat > 0) console.log(`   ‚ö†Ô∏è  ${stocksWithoutFormat} stocks sans format`);
      if (stocksWithoutProduct > 0) console.log(`   ‚ö†Ô∏è  ${stocksWithoutProduct} stocks sans produit`);
      
      if (stocksWithoutBar === 0 && stocksWithoutFormat === 0 && stocksWithoutProduct === 0) {
        console.log('‚úÖ Toutes les relations semblent correctes');
        console.log('   ‚Üí Le probl√®me est probablement dans le JavaScript c√¥t√© client');
        console.log('   ‚Üí Ouvrez F12 ‚Üí Console dans votre navigateur pour voir les erreurs');
      }
    }
    
    console.log('\nüì± √âTAPE 7: V√©rifications c√¥t√© navigateur recommand√©es');
    console.log('1. Ouvrez F12 ‚Üí Console');
    console.log('2. Rechargez la page (F5)');
    console.log('3. S√©lectionnez un bar dans le dropdown');
    console.log('4. Regardez les erreurs JavaScript');
    console.log('5. Onglet Network ‚Üí Voir les appels API et leurs r√©ponses');
    
  } catch (error) {
    console.error('‚ùå Erreur pendant le diagnostic:', error);
  }
}

deepDebugStockDisplay().then(() => process.exit(0)).catch(() => process.exit(1));